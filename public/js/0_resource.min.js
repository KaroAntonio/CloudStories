function increase_brightness(e,n){e=e.replace(/^\s*#|\s*$/g,""),3==e.length&&(e=e.replace(/(.)/g,"$1$1"))
var t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16)
return"#"+(0|256+t+(256-t)*n/100).toString(16).substr(1)+(0|256+r+(256-r)*n/100).toString(16).substr(1)+(0|256+i+(256-i)*n/100).toString(16).substr(1)}function inverse(e){if(7!=e.length||0!=e.indexOf("#"))return null
var n=(255-parseInt(e.substring(1,3),16)).toString(16),t=(255-parseInt(e.substring(3,5),16)).toString(16),r=(255-parseInt(e.substring(5,7),16)).toString(16),i="#"+pad(n)+pad(t)+pad(r)
return i}function pad(e){return e.length<2?"0"+e:e}function createContext(){var e=new Array(1e3)
e[0]="The sky",e[1]="Everything and more",e[2]="The clear star that is yesterday",e[3]="Tomorrow",e[4]="An old apple",e[5]="Camouflage paint",e[6]="A sound you heard",e[7]="A setback of the heart",e[8]="The body of mind",e[9]="A classical composition",e[10]="Another day",e[11]="Chair number eleven",e[12]="Nihilism",e[13]="Tranquility",e[14]="Wondrous awe",e[15]="That memory we used to share",e[16]="Nothing of importance",e[17]="Clear water",e[18]="Gasoline",e[19]="Sixty-four",e[20]="Nothingness",e[21]="The flow of quizzes",e[22]="An enigma",e[23]="A wave loudly clashing against a long shoreline",e[24]="Stupidity",e[25]="Love",e[26]="Sex",e[27]="An idea",e[28]="The last sentence you saw",e[29]="The person you were before",e[30]="A flailing monkey",e[31]="Organisational culture",e[32]="Trickery",e[33]="A caring mother",e[34]="A sickingly prodigous profile",e[35]="A fly",e[36]="Two-finger John",e[37]="Sevenworm",e[38]="Pinocchio",e[39]="Lucky number slevin",e[40]="A shooting star",e[41]="Whiskey on the table",e[42]="A cranky old lady",e[43]="Stew and rum",e[44]="Spam",e[45]="Lonely Henry",e[46]="Style",e[47]="Fashion",e[48]="A principal idea",e[49]="Too long a stick",e[50]="A glittering gem",e[51]="That way",e[52]="Significant understanding",e[53]="Passion or serendipity",e[54]="A late night",e[55]="A stumbling first step",e[56]="That stolen figurine",e[57]="A token of gratitude",e[58]="A small mercy",e[59]="Utter nonsense",e[60]="Colorful clay",e[61]="Insignificance",e[62]="The light at the end of the tunnel",e[63]="The other side",e[64]="Abstraction",e[65]="Rock music",e[66]="A passionate evening",e[67]="A great silence",e[68]="A river a thousand paces wide",e[69]="The legend of the raven's roar",e[70]="Enqoyism"
var n=new Array(1e3)
n[0]="is like a painted flower; it never wilts.",n[1]="runs through everything.",n[2]="is ever present.",n[3]="lies ahead, what with the future yet to come.",n[4]="approaches at high velocity!",n[5]="is nonsensical, much like me.",n[6]="likes to take a walk in the park.",n[7]="is still not very coherent.",n[8]="loves to love.",n[9]="would die for a grapefruit!",n[10]="sickens me.",n[11]="has your skin crawling.",n[12]="makes people shiver.",n[13]="is always a pleasure.",n[14]="could please even the most demanding follower of Freud.",n[15]="slips on a banana peel.",n[16]="is nothing at all?",n[17]="doesn't like paying taxes.",n[18]="would kindly inquire something about you.",n[19]="is not yet ready to die.",n[20]="is omni-present, much like candy.",n[21]="is good for you.",n[22]="does not make any sense.",n[23]="gambles with lives, happiness, and even destiny itself!",n[24]="would scare any linguist away.",n[25]="sees the sun.",n[26]="is running away.",n[27]="jumps both ways.",n[28]="can get both high and low.",n[29]="tests the thesis that your theorem would unleash.",n[30]="comes asking for bread.",n[31]="is interdependant on the relatedness of motivation, subcultures, and management.",n[32]="says hello.",n[33]="tenderly sees to her child.",n[34]="wants to go to hell.",n[35]="is often pregnant.",n[36]="is often one floor above you.",n[37]="likes to have a shower in the morning.",n[38]="wants to set things right.",n[39]="tells the tale of towers.",n[40]="stole the goods.",n[41]="woke the prime minister.",n[42]="shot the sheriff.",n[43]="lay down on the riverbed.",n[44]="asked you a question?",n[45]="sat down once more.",n[46]="shoots pineapples with a machinegun.",n[47]="will take you to places you never expected not to visit!",n[48]="revels in authority.",n[49]="stands upon somebody else's legs.",n[50]="visits Japan in the winter.",n[51]="says goodbye to the shooter.",n[52]="welcomes spring!",n[53]="loves a good joke!",n[54]="is a storyteller without equal.",n[55]="rains heavily.",n[56]="is like a summer breeze.",n[57]="is f***ing cosmopolitan, having a trained assassin stay overnight, letting heartbreaking lies roll over us like a summer breeze.",n[58]="wanted the TRUTH!",n[59]="set a treehouse on fire.",n[60]="bathes in sunlight.",n[61]="has its world rocked by trees (or rocks).",n[62]="ever stuns the onlooker.",n[63]="brings both pleasure and pain.",n[64]="takes the world for granted.",n[65]="is not enough.",n[66]="was always the second best.",n[67]="is not all that great.",n[68]="shakes beliefs widely held.",n[69]="always strikes for the heart.",n[70]="is belief in the interrelatedness of all things."
var t=0,r=0,i=71,o=71,s={i1:t,i2:r,nx:i,vx:o,n:e,v:n}
return s}function generate(e,n){var n=createContext()
return 1==e?n.i1=get_random(n.nx):2==e?n.i2=get_random(n.vx):(n.i1=get_random(n.nx),n.i2=get_random(n.vx)),n.n[n.i1]+" "+n.v[n.i2]}function qrand(e){return RandSeed=(RandMultiplier*RandSeed+RandIncrement)%2147483647,(RandSeed>>16)%e}function qinit(){RandMultiplier=22695477,RandIncrement=1
var e=new Date
RandSeed=e.getTime()%4294967295,FirstSentence=1,FirstAmerica=1}function GenRandomSentenceTemplate(){var e="",n=17,t=qrand(n+5)
return t>n?e="1 2 1.":1==t?e="1 2 1, 3 1 2 1.":2==t?e="When 1 4, 1 4.":3==t?e="If 1 2 1, then 1 4.":4==t?e="Sometimes 1 4, but 1 always 2 1!":5==t?e="Most people believe that 1 2 1, but they need to remember how 7 1 4.":6==t?FirstAmerica?(FirstAmerica=0,e="1, 1, and 1 are what made America great!"):e="1 2 1.":7==t?e="1 4, 3 1 2 1.":8==t?e="Now and then, 1 2 1.":9==t?e="1 4, and 1 4; however, 1 2 1.":10==t?e=FirstSentence?"1 2 1.":"Indeed, 1 2 1.":11==t?e=FirstSentence?"1 2 1.":"Furthermore, 1 4, and 1 2 1.":12==t?e=FirstSentence?"1 2 1.":"For example, 1 indicates that 1 2 1.":13==t?e="When you see 1, it means that 1 4.":14==t?e="Any 0 can 5 1, but it takes a real 0 to 5 1.":15==t?e="1 is 6.":16==t&&(e="When 1 is 6, 1 2 1."),FirstSentence=0,e}function GenNoun(){var e=125,n=qrand(e),t=""
return 0==n?t="cocker spaniel":1==n?t="roller coaster":2==n?t="abstraction":3==n?t="pine cone":4==n?t="microscope":5==n?t="bottle of beer":6==n?t="bowling ball":7==n?t="grain of sand":8==n?t="wheelbarrow":9==n?t="pork chop":10==n?t="bullfrog":11==n?t="squid":12==n?t="tripod":13==n?t="girl scout":14==n?t="light bulb":15==n?t="hole puncher":16==n?t="carpet tack":17==n?t="submarine":18==n?t="diskette":19==n?t="tape recorder":20==n?t="anomaly":21==n?t="insurance agent":22==n?t="mortician":23==n?t="fire hydrant":24==n?t="photon":25==n?t="line dancer":26==n?t="paper napkin":27==n?t="stovepipe":28==n?t="graduated cylinder":29==n?t="hydrogen atom":30==n?t="garbage can":31==n?t="reactor":32==n?t="power drill":33==n?t="scooby snack":34==n?t="freight train":35==n?t="ocean":36==n?t="bartender":37==n?t="senator":38==n?t="mating ritual":39==n?t="briar patch":40==n?t="jersey cow":41==n?t="chain saw":42==n?t="prime minister":43==n?t="cargo bay":44==n?t="buzzard":45==n?t="polar bear":46==n?t="tomato":47==n?t="razor blade":48==n?t="ball bearing":49==n?t="fighter pilot":50==n?t="support group":51==n?t="fundraiser":52==n?t="cowboy":53==n?t="football team":54==n?t="cab driver":55==n?t="nation":56==n?t="ski lodge":57==n?t="mastadon":58==n?t="recliner":59==n?t="minivan":60==n?t="deficit":61==n?t="food stamp":62==n?t="wedding dress":63==n?t="fairy":64==n?t="globule":65==n?t="movie theater":66==n?t="tornado":67==n?t="rattlesnake":68==n?t="CEO":69==n?t="corporation":70==n?t="plaintiff":71==n?t="class action suit":72==n?t="judge":73==n?t="defendant":74==n?t="dust bunny":75==n?t="vacuum cleaner":76==n?t="lover":77==n?t="sandwich":78==n?t="hockey player":79==n?t="avocado pit":80==n?t="fruit cake":81==n?t="turkey":82==n?t="sheriff":83==n?t="apartment building":84==n?t="industrial complex":85==n?t="inferiority complex":86==n?t="salad dressing":87==n?t="short order cook":88==n?t="pig pen":89==n?t="grand piano":90==n?t="tuba player":91==n?t="traffic light":92==n?t="turn signal":93==n?t="paycheck":94==n?t="blood clot":95==n?t="earring":96==n?t="blithe spirit":97==n?t="customer":98==n?t="warranty":99==n?t="grizzly bear":100==n?t="cyprus mulch":101==n?t="pit viper":102==n?t="crank case":103==n?t="oil filter":104==n?t="steam engine":105==n?t="chestnut":106==n?t="chess board":107==n?t="pickup truck":108==n?t="cheese wheel":109==n?t="eggplant":110==n?t="umbrella":111==n?t="skyscraper":112==n?t="dolphin":113==n?t="asteroid":114==n?t="parking lot":115==n?t="demon":116==n?t="tabloid":117==n?t="particle accelerator":118==n?t="cloud formation":119==n?t="cashier":120==n?t="burglar":121==n?t="spider":122==n?t="cough syrup":123==n?t="satellite":124==n&&(t="scythe"),t}function GenPreposition(){var e=14,n=qrand(e),t=""
return 0==n?t="of":1==n?t="from":2==n?t="near":3==n?t="about":4==n?t="around":5==n?t="for":6==n?t="toward":7==n?t="over":8==n?t="behind":9==n?t="beyond":10==n?t="related to":11==n?t="defined by":12==n?t="inside":13==n&&(t="living with"),t}function GenNounPhrase(e){var n=qrand(3),t=""
0==n||e>0?t=GenNoun():1==n?t=GenAdjective()+" "+GenNoun():2==n&&(t=GenNoun()+" "+GenPreposition()+" "+GenNounPhrase(e+1))
var r=qrand(100)
if(30>r)t="the "+t
else if(35>r)t="another "+t
else if(40>r)t="some "+t
else{var i=t.substring(0,1).toLowerCase()
t="Eurasian"==t.substring(0,8)||"a"!=i&&"e"!=i&&"i"!=i&&"o"!=i&&"u"!=i?"a "+t:"an "+t}return t}function GenAdverb(){var e=28,n=qrand(e),t=""
return 0==n?t="knowingly":1==n?t="slyly":2==n?t="greedily":3==n?t="hesitantly":4==n?t="secretly":5==n?t="carelessly":6==n?t="thoroughly":7==n?t="barely":8==n?t="ridiculously":9==n?t="non-chalantly":10==n?t="hardly":11==n?t="eagerly":12==n?t="feverishly":13==n?t="lazily":14==n?t="inexorably":15==n?t="accurately":16==n?t="accidentally":17==n?t="completely":18==n?t="usually":19==n?t="single-handledly":20==n?t="underhandedly":21==n?t="almost":22==n?t="wisely":23==n?t="ostensibly":24==n?t="somewhat":25==n?t="overwhelmingly":26==n?t="seldom":27==n&&(t="often"),t}function GenAdjective(){var e=105,n=qrand(e),t=""
return 0==n?t="slow":1==n?t="surly":2==n?t="gentle":3==n?t="optimal":4==n?t="treacherous":5==n?t="loyal":6==n?t="smelly":7==n?t="ravishing":8==n?t="annoying":9==n?t="burly":10==n?t="raspy":11==n?t="moldy":12==n?t="blotched":13==n?t="federal":14==n?t="phony":15==n?t="magnificent":16==n?t="alleged":17==n?t="crispy":18==n?t="gratifying":19==n?t="elusive":20==n?t="revered":21==n?t="spartan":22==n?t="righteous":23==n?t="mysterious":24==n?t="worldly":25==n?t="cosmopolitan":26==n?t="college-educated":27==n?t="bohemian":28==n?t="statesmanlike":29==n?t="stoic":30==n?t="hypnotic":31==n?t="dirt-encrusted":32==n?t="purple":33==n?t="infected":34==n?t="shabby":35==n?t="tattered":36==n?t="South American":37==n?t="Alaskan":38==n?t="overripe":39==n?t="self-loathing":40==n?t="frustrating":41==n?t="rude":42==n?t="pompous":43==n?t="impromptu":44==n?t="makeshift":45==n?t="so-called":46==n?t="proverbial":47==n?t="molten":48==n?t="wrinkled":49==n?t="psychotic":50==n?t="foreign":51==n?t="familiar":52==n?t="pathetic":53==n?t="precise":54==n?t="moronic":55==n?t="polka-dotted":56==n?t="varigated":57==n?t="mean-spirited":58==n?t="false":59==n?t="linguistic":60==n?t="temporal":61==n?t="fractured":62==n?t="dreamlike":63==n?t="imaginative":64==n?t="cantankerous":65==n?t="obsequious":66==n?t="twisted":67==n?t="load bearing":68==n?t="orbiting":69==n?t="radioactive":70==n?t="unstable":71==n?t="outer":72==n?t="nearest":73==n?t="most difficult":74==n?t="Eurasian":75==n?t="hairy":76==n?t="flabby":77==n?t="soggy":78==n?t="muddy":79==n?t="salty":80==n?t="highly paid":81==n?t="greasy":82==n?t="fried":83==n?t="frozen":84==n?t="boiled":85==n?t="incinerated":86==n?t="vaporized":87==n?t="nuclear":88==n?t="paternal":89==n?t="childlike":90==n?t="feline":91==n?t="fat":92==n?t="skinny":93==n?t="green":94==n?t="financial":95==n?t="frightened":96==n?t="fashionable":97==n?t="resplendent":98==n?t="flatulent":99==n?t="mitochondrial":100==n?t="overpriced":101==n?t="snooty":102==n?t="self-actualized":103==n?t="miserly":104==n&&(t="geosynchronous"),qrand(10)>7&&(t=GenAdverb()+" "+t),t}function GenTransitiveVerbPhrase(e){var n=56,t=qrand(n),r=""
0==t?r="eat$":1==t?r="conquer$":2==t?r="figure$ out":3==t?r="know$":4==t?r="teach*":5==t?r="require$ assistance from":6==t?r="pour$ freezing cold water on":7==t?r="find$ lice on":8==t?r="seek$":9==t?r="ignore$":10==t?r="dance$ with":11==t?r="recognize$":12==t?r="compete$ with":13==t?r="reach* an understanding with":14==t?r="negotiate$ a prenuptial agreement with":15==t?r="assimilate$":16==t?r="bestow$ great honor upon":17==t?r="derive$ perverse satisfaction from":18==t?r="steal$ pencils from":19==t?r="tr& to seduce":20==t?r="go* deep sea fishing with":21==t?r="find$ subtle faults with":22==t?r="laugh$ and drink$ all night with":23==t?r="befriend$":24==t?r="make$ a truce with":25==t?r="give$ secret financial aid to":26==t?r="brainwash*":27==t?r="trade$ baseball cards with":28==t?r="sell$ "+GenNounPhrase(0)+" to":29==t?r="caricature$":30==t?r="sanitize$":31==t?r="satiate$":32==t?r="organize$":33==t?r="graduate$ from":34==t?r="give$ lectures on morality to":35==t?r="^ a change of heart about":36==t?r="play$ pinochle with":37==t?r="give$ a pink slip to":38==t?r="share$ a shower with":39==t?r="buy$ an expensive gift for":40==t?r="cook$ cheese grits for":41==t?r="take$ a peek at":42==t?r="pee$ on":43==t?r="write$ a love letter to":44==t?r="fall$ in love with":45==t?r="avoid$ contact with":46==t?r=") a big fan of":47==t?r="secretly admire$":48==t?r="borrow$ money from":49==t?r="operate$ a small fruit stand with":50==t?r="throw$ "+GenNounPhrase(0)+" at":51==t?r="bur&":52==t?r="can be kind to":53==t?r="learn$ a hard lesson from":54==t?r="plan$ an escape from "+GenNounPhrase(0):55==t&&(r="make$ love to"),vt=""
var i
for(i=0;i<r.length;i++){var o=r.substring(i,i+1),s=o
"$"==o?0==e?s="":1==e&&(s="s"):"*"==o?0==e?s="":1==e&&(s="es"):")"==o?0==e?s="be":1==e&&(s="is"):"^"==o?0==e?s="have":1==e&&(s="has"):"&"==o&&(0==e?s="y":1==e&&(s="ies")),vt+=s}return qrand(10)<3&&(vt=GenAdverb()+" "+vt),vt}function GenIntransitiveVerbPhrase(){var e=28,n=qrand(e),t=""
return 0==n?t="leaves":1==n?t="goes to sleep":2==n?t="takes a coffee break":3==n?t="hibernates":4==n?t="reads a magazine":5==n?t="self-flagellates":6==n?t="meditates":7==n?t="starts reminiscing about lost glory":8==n?t="flies into a rage":9==n?t="earns frequent flier miles":10==n?t="sweeps the floor":11==n?t="feels nagging remorse":12==n?t="returns home":13==n?t="rejoices":14==n?t="prays":15==n?t="procrastinates":16==n?t="daydreams":17==n?t="ceases to exist":18==n?t="hides":19==n?t="panics":20==n?t="beams with joy":21==n?t="laughs out loud":22==n?t="gets stinking drunk":23==n?t="wakes up":24==n?t="hesitates":25==n?t="trembles":26==n?t="ruminates":27==n&&(t="dies"),t}function GenConjunction(){var e=4,n=qrand(e),t=""
return 0==n?t="and":1==n?t="or":2==n?t="but":3==n&&(t="because"),t}function CapFirst(e){return e.substring(0,1).toUpperCase()+e.substring(1,e.length)}function GenRandomSentence(){var e,n=GenRandomSentenceTemplate(),t=""
for(e=0;e<n.length;e++){var r=n.substring(e,e+1),i=""
i="0"==r?GenNoun():"1"==r?GenNounPhrase(0):"2"==r?GenTransitiveVerbPhrase(1):"3"==r?GenConjunction():"4"==r?GenIntransitiveVerbPhrase():"5"==r?GenTransitiveVerbPhrase(0):"6"==r?GenAdjective():"7"==r?GenAdverb():r,t+=i}return CapFirst(t)}function listen_for_bumps(){if("undefined"!=typeof EventSource){var e=new EventSource("/updateStories.php")
e.onmessage=function(e){var n=JSON.parse(e.data)
null!=n&&storyLine[0].id==Number(n[0])&&(requestSubtree(Number(n[0])),null!=findLine(n[1])&&(buildStoryLine(n[1]),branches=findBranches(n[1]),drawAll()))}}}function init_location_listener(e){return setInterval(requestLocations,e)}function removeUserIcons(){$(".user_icon").remove()}function requestLocations(){var xmlhttp
return xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xmlhttp.open("GET","/get_locations",!0),xmlhttp.send(),xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&(locations=eval("("+xmlhttp.responseText+")"),removeUserIcons(),drawUserIcons())},!0}function requestSubtree(id,depth,callback){var xmlhttp
return xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),void 0==id&&(id=1),xmlhttp.open("GET","/get_subtree/"+id+"/"+depth,!0),xmlhttp.send(),xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&200==xmlhttp.status){var subtree=eval("("+xmlhttp.responseText+")")
appendSubtree(subtree),0==branches.length&&showStory(storyLine[0].id),void 0!==callback&&("click"==callback?clickStory(subtree[0]):callback())}},!0}function initPrefs(e){return"tips_enabled"in e?"true"===e.tips_enabled?e.tips_enabled=!0:e.tips_enabled=!1:e.tips_enabled=!0,e}function postPreferences(e){$.ajaxSetup({headers:{"X-CSRF-Token":$("meta[name=_token]").attr("content")}})
$.post("update_prefs",e,onSuccess)}function onSuccess(e,n,t){console.log(e,n,t)}function stripHTML(e){var n=document.createElement("DIV")
return n.innerHTML=e,n.textContent||n.innerText||""}function disable_form(e){$(e).on("keyup keypress",function(e){var n=e.keyCode||e.which
return 13==n?(e.preventDefault(),!1):void 0})}function releaseKey(e){16==e&&(shiftDown=!1)}function triggerKey(e){document.forms.line_form.line.value.trim()
return"line"==document.activeElement.name?void(13==e&&submitForm()):($("#line").blur(),void(13==e?clickStory(null==selected?storyLine[0]:selected):16==e?(shiftDown=!0,storyLine.length>0&&clickStory(storyLine[1])):38==e&&shiftDown&&storyLine.length>0&&clickStory(storyLine[1])))}function get_random(e){var n=Math.floor(Math.random()*e)
return n}function buildStoryLine(e){if(null!=findLine(e)){for(storyLine=[findLine(e)],storyLine[0].top=isTop(e);1!=storyLine[storyLine.length-1].id;){var n=findLine(storyLine[storyLine.length-1].parentID)
if(null==n)break
n.top=isTop(n.id),storyLine.push(n)}branches=findBranches(storyLine[0].id)}}function goto(e){return console.log(e),!1}function isTop(e){for(var n=findLine(e),t=findBranches(n.parentID),r=0,i=0;i<t.length;i++)Number(t[i].visits)>r&&(r=t[i].visits)
return Number(n.visits)>=Number(r)}function findBranches(e){var n=[]
for(i=0;i<stories.length;i++)stories[i].parentID==e&&n.push(stories[i])
return n}function findLine(e){for(i=0;i<stories.length;i++)if(stories[i].id==e)return stories[i]
return null}function appendSubtree(e){storyIDs=[]
for(var n=0;n<stories.length;n++)storyIDs.push(Number(stories[n].id))
for(var n=0;n<e.length;n++)-1==storyIDs.indexOf(Number(e[n].id))&&stories.push(e[n])}function showStory(e){buildStoryLine(e),branches=findBranches(e),drawAll()}function clickStory(e){null!=e&&set_cookie("last_line_id",e.id,200),null!=e&&(null!=user&&(user.experience+=1),-1!=e.id?(showStory(e.id),requestSubtree(e.id,subtree_depth)):($("#line").val(e.line),submitForm()))}function suggestLine(){var e=[function(){return generate()},function(){return qinit(),GenRandomSentence()}],n=e[get_random(e.length-1)]()
$("#line").val(n)}function submitForm(){var e=document.forms.line_form.line.value.trim()
e=stripHTML(e),$("#line").val(e)
var n=e.toLowerCase()
if(""==n)return 0!=branches&&clickStory(branches[0]),void("line"==document.activeElement.name&&$("#line").blur())
for(var t=findBranches(storyLine[0].id),r=0;r<t.length;r++)if(t[r].line.toLowerCase()==n)return clickStory(t[r]),void $("#line").val("")
$("#parentID").val(storyLine[0].id)
var i=null==user?0:user.id
$("#authorID").val(i)
var o=$.post("store",$("#line_form").serialize())
$("#line").val(""),o.done(function(e){num_lines++,appendSubtree([e]),clickStory(e)})}function initTips(){hideTip()
for(var e=Object.keys(tip_library),n=0;n<e.length;n++)$(e[n]).on("mouseover",function(e){return function(){showTip(e,"#tips_container")}}(e[n])),$(e[n]).on("mouseout",function(e){return function(){hideTip(e)}}(e[n]))}function disableTips(){tips_enabled=!1,$("#tips_container")[0].innerHTML="",preferences.tips_enabled=!1,postPreferences(preferences),set_cookie("tips_enabled",!1,200)}function hideTip(e){tips_enabled&&(showTip("default","#tips_container"),$(e).css("background","transparent"),$(e).css("border","none"))}function showTip(e,n,t,r,i){if(t="undefined"!=typeof t?t:!0,r="undefined"!=typeof r?r:!1,i="undefined"!=typeof i?i:tip_library,tips_enabled){var o=i[e]
$(n)[0].innerHTML=""
var s=""
t&r&&(s+="<div class='large_tip_title'>"+o.title+"</div>"),t&!r&&(s+="<div class='tip_title'>"+o.title+"</div>"),s+=r?"<div class='large_tip_content'>"+o.content+"</div>":"<div class='tip_content'>"+o.content+"</div>",$(n)[0].innerHTML=s}}function getTipKey(e,n){return Object.keys(e)[n]}function showBannerTip(e){showTip(getTipKey(intro_library,e),"#banner_tips",0!=e,!0,intro_library),$("#banner_nav")[0].innerHTML="",$("#banner_nav")[0].innerHTML+="<div id='banner_register' class='words_link auth_button' onclick='location.href=\"/auth/register\"'><a class='auth_button'>NEW<a></div>",$("#banner_nav")[0].innerHTML+="<div id='banner_login' class='words_link auth_button' onclick='location.href=\"/auth/login\"'><a class='auth_button'>RETURN<a></div>",$("#banner_nav")[0].innerHTML+="<div id='next_button' class='nav_button' onclick='showBannerTip("+(e+1)+")'>NEXT></div>",$("#banner_nav")[0].innerHTML+="<div id='start_button' class='regular_button'>LATER</div>",void 0==getTipKey(intro_library,e+1)?($("#next_button")[0].style.display="none",$("#start_button")[0].style.display="none"):$("#start_button")[0].style.display="none",$("#close_tips").on("click",hideBannerTip),$("#start_button").on("click",hideBannerTip),$("#disable_tips").remove()}function hideBannerTip(){$("#veil").css("display","none"),set_cookie("banner_enabled",!1,200)}function set_cookie(e,n,t,r){var i=r?"; domain="+r:""
document.cookie=e+"="+encodeURIComponent(n)+"; max-age="+86400*t+"; path=/"+i}function is_cookie(e){var n=document.cookie
if(0!=n.length){var t=n.match(e+"=([^;]*)")
return null!=t}return!1}function get_cookie(e){var n=document.cookie
if(0!=n.length){var t=n.match(e+"=([^;]*)")
return decodeURIComponent(t[1])}return""}function drawAll(){drawStoryLine(),drawBranches(),drawStats(),drawUserIcons(),enableTree&&drawTree()}function drawUserIcons(){var e=20
if(null!=locations&&null!=user)for(var n={},t=0;t<locations.length;t++){var r=locations[t]
if(r.uid!=user.id&(!(r.line_id in n)|r.line_id in n&n[r.line_id]<4)){var i=$("<div></div>")
i.attr("id","user_icon_"+r.uid),i.addClass("user_icon"),i.html(r.name[0]),i.css("left",e*n[r.line_id]+1+"px"),r.in_distance?(i.css("color",colorScale(colorRange)),i.css("border-color",colorScale(colorRange))):(i.css("color",colorScale(0)),i.css("border-color",colorScale(0))),$("#line_"+r.line_id).append(i),r.line_id in n?n[r.line_id]++:n[r.line_id]=1}}}function drawTree(){initTree()}function drawBackground(){renderStoryShells()}function drawStoryLine(){for($("#story_line").empty(),i=storyLine.length-1;i>=0;i--)drawLine(storyLine[i],colorScale,$("#story_line"))
$("#story_line_container")[0].scrollTop=$("#story_line_container")[0].scrollHeight}function drawBranches(){var e="#eee",n="inset 0 1px 1px rgba(0,0,0,.075), 0 0 5px "+forwardColor,t="inset 0 0 0px "+forwardColor
if($("#line").css("border-color",e),$("#line")[0].style.boxShadow=t,$("#line")[0].style.MozBoxShadow=t,$("#line")[0].style.WebKitBoxShadow=t,$("#line").focus(function(){$(this).css("border-color",forwardColor),$(this)[0].style.boxShadow=n,$(this)[0].style.MozBoxShadow=n,$(this)[0].style.WebKitBoxShadow=n}),$("#line").blur(function(){$(this).css("border-color",e),$(this)[0].style.boxShadow=t,$(this)[0].style.MozBoxShadow=t,$(this)[0].style.WebKitBoxShadow=t}),$("#branches").empty(),branches.length>0){if(null==user||1!=user.id)for(var r=0;r<branches.length;r++)263==branches[r].id&&branches.splice(r,1)
branches.sort(function(e,n){return parseFloat(e.visits)-parseFloat(n.visits)}),branches.reverse()
var i=[]
i[0]=branches.splice(0,1),i[1]=branches.splice(0,1*branches.length/3),i[2]=branches.splice(0,branches.length)
for(var r=0;r<i.length;r++)if(i[r].length>0){var o=Math.floor(Math.random()*i[r].length)
branches.unshift(i[r].splice(o,1)[0])}branches.length>0?selected=branches[branches.length-1]:selected=null,branches.sort(function(e,n){return parseFloat(n.visits)-parseFloat(e.visits)})
var s=backColor
for(0==branches[0].visits&&(s=maxBranchColor),branchColorScale=d3.scale.linear().range([s,maxBranchColor]).domain([0,branches[0].visits]).clamp(!0),branches.length<=3&&$("#branches").height($(".line").height()*branches.length),r=0;r<branches.length;r++)drawLine(branches[r],branchColorScale,$("#branches"),0==r)
for(r=0;r<i.length;r++)for(o=0;o<i[r].length;o++)drawLine(i[r][o],branchColorScale,$("#branches"))}else selected=null,$("#branches").height(10)
0==branches.length&&storyLine.length>1&&document.getElementById("line").focus()}function colorLine(e,n,t,r){"branches"==r[0].id?t.style.color=n(e.visits):t.style.color=n(storyLine.indexOf(e))}function drawLine(e,n,t,r){r="undefined"!=typeof r?r:!1
var o=document.createElement("DIV")
"Anonymous"!=e.author_name&&void 0!=e.author_name&&(o.innerHTML="-"+e.author_name),o.id="info_"+e.id,o.className="info",debug&&(o.innerHTML+=" : "+e.visits),debug_ids&&(o.innerHTML+=" : "+e.id)
var s=document.createElement("DIV")
colorLine(e,n,s,t),s.id="line_"+e.id,s.className="line",s.innerHTML=e.line
var a=function(e,n,t){return function(){n.style.color="#aaa",e.style["font-style"]="italic",e.style.color=colorScale(0)}}(s,o,e),l=function(e,r,i,o){return function(){r.style.color="transparent",e.style["font-style"]="normal",colorLine(o,n,s,t)}}(s,o,i,e)
s.onmouseenter=a,o.onmouseenter=a,s.onmouseout=l,o.onmouseout=l,s.onclick=function(e){return function(){clickStory(e)}}(e),t[0].appendChild(o),t[0].appendChild(s),o.style.marginLeft=-o.offsetWidth+"px"}function drawStats(){null!=user&&($("#user_stats")[0].innerHTML=""+user.experience+" // "+user.prestige+" // "+num_lines)}function displayAlphaWarning(){$("#alpha_warning").css("display","block")}function hideAlphaWarning(){$("#alpha_warning").css("display","none")}function setup(){var e=createCanvas(window.innerWidth,window.innerHeight)
e.parent("background")}function renderStoryShells(){background("#fff")
for(var e=50,n=storyLine.length-1;n>=0;n--)fill(stringColor(storyLine[n].line,forwardColor,.95)),noStroke(),ellipse(window.innerWidth/2,window.innerHeight/2,n*e,n*e)}function stringColor(e,n,t){for(var r=0,i=0;i<e.length;i++)r+=e.charCodeAt(i)*i
return 1118481>r&&(r+=13118481),shadeColor("#"+(r%16777215).toString(16),t)}function shadeColor(e,n){var t=parseInt(e.slice(1),16),r=0>n?0:255,i=0>n?-1*n:n,o=t>>16,s=t>>8&255,a=255&t
return"#"+(16777216+65536*(Math.round((r-o)*i)+o)+256*(Math.round((r-s)*i)+s)+(Math.round((r-a)*i)+a)).toString(16).slice(1)}function blendColors(e,n,t){var r=parseInt(e.slice(1),16),i=parseInt(n.slice(1),16),o=r>>16,s=r>>8&255,a=255&r,l=i>>16,c=i>>8&255,u=255&i
return"#"+(16777216+65536*(Math.round((l-o)*t)+o)+256*(Math.round((c-s)*t)+s)+(Math.round((u-a)*t)+a)).toString(16).slice(1)}function buildTree(e,n){var t=findLine(n),r=[t]
if("0"!=t.parentID){var i=findLine(t.parentID)
i.children=[t],t=i}for(;r.length>0;){var o=r[0]
r.splice(0,1),o.children=findBranches(o.id),r=r.concat(o.children)}return t}function initTree(){var e={top:20,right:120,bottom:20,left:120},n=width-e.right-e.left,t=800-e.top-e.bottom
tree=d3.layout.tree().size([height,width]),diagonal=d3.svg.diagonal().projection(function(e){return[e.y+10,e.x]}),$("#tree_container").empty(),svg=d3.select("#tree_container").append("svg").attr("width",n+e.right+e.left).attr("height",t+e.top+e.bottom).append("g").attr("transform","translate("+e.left+","+e.top+")"),root=buildTree(stories,get_cookie("last_line_id")),root.x0=t/2,root.y0=0,update(root)}function update(e){var n=tree.nodes(root).reverse(),t=tree.links(n)
n.forEach(function(e){e.y=180*e.depth})
var r=svg.selectAll("g.node").data(n,function(e){return e.id||(e.id=++node_i)}),i=r.enter().append("g").attr("class","node").attr("transform",function(n){return"translate("+e.y0+","+e.x0+")"}).on("click",click)
i.append("circle").attr("r",1e-6).style("fill",function(e){return e._children?"#FFB2B2":"#fff"}),i.append("text").attr("x",function(e){return e.children||e._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(e){return e.children||e._children?"end":"start"}).text(function(e){return e.line}).attr("transform","rotate(-5)").style("fill-opacity",1e-6)
var o=r.transition().duration(duration).attr("transform",function(e){return"translate("+e.y+","+e.x+")"})
o.select("circle").attr("r",4.5).style("fill",function(e){return e._children?"#FFB2B2":"#fff"}),o.select("text").style("fill-opacity",1)
var s=r.exit().transition().duration(duration).attr("transform",function(n){return"translate("+e.y+","+e.x+")"}).remove()
s.select("circle").attr("r",1e-6),s.select("text").style("fill-opacity",1e-6)
var a=svg.selectAll("path.link").data(t,function(e){return e.target.id})
a.enter().insert("path","g").attr("class","link").attr("d",function(n){var t={x:e.x0,y:e.y0}
return diagonal({source:t,target:t})}),a.transition().duration(duration).attr("d",diagonal),a.exit().transition().duration(duration).attr("d",function(n){var t={x:e.x,y:e.y}
return diagonal({source:t,target:t})}).remove(),n.forEach(function(e){e.x0=e.x,e.y0=e.y})}function click(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null),clickStory(e),update(e)}var module,countdown=function(e){function n(e,n){var t=e.getTime()
return e.setMonth(e.getMonth()+n),Math.round((e.getTime()-t)/864e5)}function t(e){var n=e.getTime(),t=new Date(n)
return t.setMonth(e.getMonth()+1),Math.round((t.getTime()-n)/864e5)}function r(e,n){if(n=n instanceof Date||null!==n&&isFinite(n)?new Date(+n):new Date,!e)return n
var t=+e.value||0
return t?(n.setTime(n.getTime()+t),n):((t=+e.milliseconds||0)&&n.setMilliseconds(n.getMilliseconds()+t),(t=+e.seconds||0)&&n.setSeconds(n.getSeconds()+t),(t=+e.minutes||0)&&n.setMinutes(n.getMinutes()+t),(t=+e.hours||0)&&n.setHours(n.getHours()+t),(t=+e.weeks||0)&&(t*=7),(t+=+e.days||0)&&n.setDate(n.getDate()+t),(t=+e.months||0)&&n.setMonth(n.getMonth()+t),(t=+e.millennia||0)&&(t*=10),(t+=+e.centuries||0)&&(t*=10),(t+=+e.decades||0)&&(t*=10),(t+=+e.years||0)&&n.setFullYear(n.getFullYear()+t),n)}function i(e,n){return m(e)+(1===e?c[n]:u[n])}function o(){}function s(e,n,r,i,o,s){if(0<=e[r]&&(n+=e[r],delete e[r]),n/=o,1>=n+1)return 0
if(0<=e[i]){switch(e[i]=+(e[i]+n).toFixed(s),i){case"seconds":if(60!==e.seconds||isNaN(e.minutes))break
e.minutes++,e.seconds=0
case"minutes":if(60!==e.minutes||isNaN(e.hours))break
e.hours++,e.minutes=0
case"hours":if(24!==e.hours||isNaN(e.days))break
e.days++,e.hours=0
case"days":if(7!==e.days||isNaN(e.weeks))break
e.weeks++,e.days=0
case"weeks":if(e.weeks!==t(e.refMonth)/7||isNaN(e.months))break
e.months++,e.weeks=0
case"months":if(12!==e.months||isNaN(e.years))break
e.years++,e.months=0
case"years":if(10!==e.years||isNaN(e.decades))break
e.decades++,e.years=0
case"decades":if(10!==e.decades||isNaN(e.centuries))break
e.centuries++,e.decades=0
case"centuries":if(10!==e.centuries||isNaN(e.millennia))break
e.millennia++,e.centuries=0}return 0}return n}function a(e,r,i,o,a,l){var c=new Date
e.start=r=r||c,e.end=i=i||c,e.units=o,e.value=i.getTime()-r.getTime(),0>e.value&&(c=i,i=r,r=c),e.refMonth=new Date(r.getFullYear(),r.getMonth(),15,12,0,0)
try{e.millennia=0,e.centuries=0,e.decades=0,e.years=i.getFullYear()-r.getFullYear(),e.months=i.getMonth()-r.getMonth(),e.weeks=0,e.days=i.getDate()-r.getDate(),e.hours=i.getHours()-r.getHours(),e.minutes=i.getMinutes()-r.getMinutes(),e.seconds=i.getSeconds()-r.getSeconds(),e.milliseconds=i.getMilliseconds()-r.getMilliseconds()
var u
for(0>e.milliseconds?(u=g(-e.milliseconds/1e3),e.seconds-=u,e.milliseconds+=1e3*u):1e3<=e.milliseconds&&(e.seconds+=b(e.milliseconds/1e3),e.milliseconds%=1e3),0>e.seconds?(u=g(-e.seconds/60),e.minutes-=u,e.seconds+=60*u):60<=e.seconds&&(e.minutes+=b(e.seconds/60),e.seconds%=60),0>e.minutes?(u=g(-e.minutes/60),e.hours-=u,e.minutes+=60*u):60<=e.minutes&&(e.hours+=b(e.minutes/60),e.minutes%=60),0>e.hours?(u=g(-e.hours/24),e.days-=u,e.hours+=24*u):24<=e.hours&&(e.days+=b(e.hours/24),e.hours%=24);0>e.days;)e.months--,e.days+=n(e.refMonth,1)
if(7<=e.days&&(e.weeks+=b(e.days/7),e.days%=7),0>e.months?(u=g(-e.months/12),e.years-=u,e.months+=12*u):12<=e.months&&(e.years+=b(e.months/12),e.months%=12),10<=e.years&&(e.decades+=b(e.years/10),e.years%=10,10<=e.decades&&(e.centuries+=b(e.decades/10),e.decades%=10,10<=e.centuries&&(e.millennia+=b(e.centuries/10),e.centuries%=10))),r=0,!(1024&o)||r>=a?(e.centuries+=10*e.millennia,delete e.millennia):e.millennia&&r++,!(512&o)||r>=a?(e.decades+=10*e.centuries,delete e.centuries):e.centuries&&r++,!(256&o)||r>=a?(e.years+=10*e.decades,delete e.decades):e.decades&&r++,!(128&o)||r>=a?(e.months+=12*e.years,delete e.years):e.years&&r++,!(64&o)||r>=a?(e.months&&(e.days+=n(e.refMonth,e.months)),delete e.months,7<=e.days&&(e.weeks+=b(e.days/7),e.days%=7)):e.months&&r++,!(32&o)||r>=a?(e.days+=7*e.weeks,delete e.weeks):e.weeks&&r++,!(16&o)||r>=a?(e.hours+=24*e.days,delete e.days):e.days&&r++,!(8&o)||r>=a?(e.minutes+=60*e.hours,delete e.hours):e.hours&&r++,!(4&o)||r>=a?(e.seconds+=60*e.minutes,delete e.minutes):e.minutes&&r++,!(2&o)||r>=a?(e.milliseconds+=1e3*e.seconds,delete e.seconds):e.seconds&&r++,!(1&o)||r>=a){var d=s(e,0,"milliseconds","seconds",1e3,l)
if(d&&(d=s(e,d,"seconds","minutes",60,l))&&(d=s(e,d,"minutes","hours",60,l))&&(d=s(e,d,"hours","days",24,l))&&(d=s(e,d,"days","weeks",7,l))&&(d=s(e,d,"weeks","months",t(e.refMonth)/7,l))){o=d
var h,f=e.refMonth,p=f.getTime(),m=new Date(p)
if(m.setFullYear(f.getFullYear()+1),h=Math.round((m.getTime()-p)/864e5),(d=s(e,o,"months","years",h/t(e.refMonth),l))&&(d=s(e,d,"years","decades",10,l))&&(d=s(e,d,"decades","centuries",10,l))&&(d=s(e,d,"centuries","millennia",10,l)))throw Error("Fractional unit overflow")}}}finally{delete e.refMonth}return e}function l(e,n,t,i,s){var l
t=+t||222,i=i>0?i:NaN,s=s>0?20>s?Math.round(s):20:0
var c=null
"function"==typeof e?(l=e,e=null):e instanceof Date||(null!==e&&isFinite(e)?e=new Date(+e):("object"==typeof c&&(c=e),e=null))
var u=null
if("function"==typeof n?(l=n,n=null):n instanceof Date||(null!==n&&isFinite(n)?n=new Date(+n):("object"==typeof n&&(u=n),n=null)),c&&(e=r(c,n)),u&&(n=r(u,e)),!e&&!n)return new o
if(!l)return a(new o,e,n,t,i,s)
var d,c=1&t?1e3/30:2&t?1e3:4&t?6e4:8&t?36e5:16&t?864e5:6048e5,u=function(){l(a(new o,e,n,t,i,s),d)}
return u(),d=setInterval(u,c)}var c,u,d,h,f,p,m,y,g=Math.ceil,b=Math.floor
o.prototype.toString=function(e){var n=y(this),t=n.length
return t?1===t?n[0]:(e=d+n.pop(),n.join(h)+e):e?""+e:f},o.prototype.toHTML=function(e,n){e=e||"span"
var t=y(this),r=t.length
if(!r)return(n=n||f)?"<"+e+">"+n+"</"+e+">":n
for(var i=0;r>i;i++)t[i]="<"+e+">"+t[i]+"</"+e+">"
return 1===r?t[0]:(r=d+t.pop(),t.join(h)+r)},o.prototype.addTo=function(e){return r(this,e)},y=function(e){var n=[],t=e.millennia
return t&&n.push(p(t,10)),(t=e.centuries)&&n.push(p(t,9)),(t=e.decades)&&n.push(p(t,8)),(t=e.years)&&n.push(p(t,7)),(t=e.months)&&n.push(p(t,6)),(t=e.weeks)&&n.push(p(t,5)),(t=e.days)&&n.push(p(t,4)),(t=e.hours)&&n.push(p(t,3)),(t=e.minutes)&&n.push(p(t,2)),(t=e.seconds)&&n.push(p(t,1)),(t=e.milliseconds)&&n.push(p(t,0)),n},l.MILLISECONDS=1,l.SECONDS=2,l.MINUTES=4,l.HOURS=8,l.DAYS=16,l.WEEKS=32,l.MONTHS=64,l.YEARS=128,l.DECADES=256,l.CENTURIES=512,l.MILLENNIA=1024,l.DEFAULTS=222,l.ALL=2047
var v=l.setFormat=function(e){if(e){if("singular"in e||"plural"in e){var n=e.singular||[]
n.split&&(n=n.split("|"))
var t=e.plural||[]
t.split&&(t=t.split("|"))
for(var r=0;10>=r;r++)c[r]=n[r]||c[r],u[r]=t[r]||u[r]}"string"==typeof e.last&&(d=e.last),"string"==typeof e.delim&&(h=e.delim),"string"==typeof e.empty&&(f=e.empty),"function"==typeof e.formatNumber&&(m=e.formatNumber),"function"==typeof e.formatter&&(p=e.formatter)}},w=l.resetFormat=function(){c=" millisecond; second; minute; hour; day; week; month; year; decade; century; millennium".split(";"),u=" milliseconds; seconds; minutes; hours; days; weeks; months; years; decades; centuries; millennia".split(";"),d=" and ",h=", ",f="",m=function(e){return e},p=i}
return l.setLabels=function(e,n,t,r,i,o,s){v({singular:e,plural:n,last:t,delim:r,empty:i,formatNumber:o,formatter:s})},l.resetLabels=w,w(),e&&e.exports?e.exports=l:"function"==typeof window.define&&"undefined"!=typeof window.define.amd&&window.define("countdown",[],function(){return l}),l}(module)
tip_library={"default":{title:"wrdcvlt",content:"<div id='banner_register' class='words_link' onclick='location.href=\"/auth/register\"'><a class='big_button'>REGISTER<a></div><div id='disable_tips' class='regular_button' onclick='disableTips()'>Turn off Tips</div>"},"#story_line":{title:"The Story",content:"this is the past, the words you've already read<br>'SHIFT' moves you back up the story<br>Hold 'SHIFT'+'UP' to fast rewind"},"#branches":{title:"The Branches",content:"these are your options, the future, your posibilities<br>the top branch is the most popular<br>'ENTER' chooses the most popular branch<br>scroll for more options"},".info":{title:"Line Info",content:"who wrote this"},"#line_form":{title:"The Next Line...",content:"is yours to write<br>'ENTER' to submit your words"},"#user_stats":{title:"Literary Stats",content:"experience // readership // oeuvre <br>experience: is earned whenever you do anything <br>readership: the number of lines read x the number of people who read them <br>oeuvre: the number of lines you've written"},"#countdown":{title:"Spread the cvlt",content:"on kickstarter"},"#suggest_line_button":{title:"Get a Suggestion",content:"summon the forces of [the internet] to craft a line"}},intro_library={title:{title:"wrdcvlt",content:'[wurd-kuhlt] noun<br>i. a branching story tree<br>ii. an obsessive group that tends lovingly to said tree<br><div id="disable_tips" class="nav_button" onclick="disableTips()">Turn off Tips</div>'},read:{title:"Read",content:"the story by choosing each line, <br>(it's like a choose your own adventure) <br>'ENTER' chooses the most popular branch"},write:{title:"Write",content:"the story from any line,<br>growing a new branch"}}
